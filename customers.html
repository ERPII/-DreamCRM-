<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>DreamCRM - × ×™×”×•×œ ×œ×§×•×—×•×ª ×¤×¨×™××™×•×</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@200;400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex">

    <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col p-6 shadow-2xl">
        <div class="text-2xl font-black mb-10 text-blue-400 border-b border-slate-700 pb-4 italic">DreamCRM</div>
        <nav class="flex-1 space-y-2">
            <a href="dashboard.html" class="block p-3 rounded-lg hover:bg-slate-800 transition">ğŸ“Š ×“××©×‘×•×¨×“</a>
            <a href="leads.html" class="block p-3 rounded-lg hover:bg-slate-800 transition">ğŸ¯ ×œ×™×“×™×</a>
            <a href="customers.html" class="block p-3 rounded-lg bg-blue-600 font-bold">ğŸ‘¥ ×œ×§×•×—×•×ª</a>
            <a href="products.html" class="block p-3 rounded-lg hover:bg-slate-800 transition">ğŸ·ï¸ ××—×™×¨×•×Ÿ</a>
            <a href="service.html" class="block p-3 rounded-lg hover:bg-slate-800 transition">ğŸ› ï¸ ×©×™×¨×•×ª</a>
            <a href="reports.html" class="block p-3 rounded-lg hover:bg-slate-800 transition">ğŸ“ˆ ×“×•×—×•×ª</a>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-10 overflow-y-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-4xl font-black text-slate-800">× ×™×”×•×œ ×œ×§×•×—×•×ª ğŸ‘¥</h1>
                <p class="text-gray-500 font-medium">××¨×›×– ××™×“×¢ 360 ××¢×œ×•×ª ×¢×œ ×”×œ×§×•×—×•×ª ×©×œ×š</p>
            </div>
            <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-2xl font-bold shadow-lg transition-all flex items-center gap-2">
                <span>+</span> ×”×•×¡×£ ×œ×§×•×— ×—×“×©
            </button>
        </header>

        <div id="customersGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="animate-pulse bg-white h-40 rounded-3xl shadow-sm"></div>
            <div class="animate-pulse bg-white h-40 rounded-3xl shadow-sm"></div>
        </div>
    </main>

    <div id="customerModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-3xl shadow-2xl overflow-y-auto p-8">
            <div class="flex justify-between items-start border-b pb-6 mb-6">
                <div>
                    <h2 id="modalCustName" class="text-3xl font-black text-slate-800">×©× ×”×œ×§×•×—</h2>
                    <p id="modalCustEmail" class="text-blue-600 font-bold"></p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-black text-2xl">âœ•</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">ğŸ“ ××™×“×¢ ×¤× ×™××™ ×•×”×¢×¨×•×ª ×¢×•×‘×“×™×</h3>
                        <textarea id="modalNotes" class="w-full h-32 p-3 rounded-xl border-none focus:ring-2 focus:ring-blue-500 text-sm italic" placeholder="×¨×©×•× ×›××Ÿ ×›×œ ××™×“×¢ ×—×©×•×‘ ×¢×œ ×”×œ×§×•×—..."></textarea>
                        <button id="saveNoteBtn" class="mt-3 bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold w-full">×©××•×¨ ×”×¢×¨×•×ª</button>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-blue-50 p-6 rounded-2xl">
                        <h3 class="font-bold text-blue-800 mb-3 flex items-center gap-2">ğŸ› ï¸ ×§×¨×™××•×ª ×©×™×¨×•×ª ××—×¨×•× ×•×ª</h3>
                        <div id="modalTickets" class="space-y-2 text-sm text-blue-900">
                            </div>
                    </div>
                    <div class="bg-indigo-50 p-6 rounded-2xl">
                        <h3 class="font-bold text-indigo-800 mb-3 flex items-center gap-2">ğŸ·ï¸ ××•×¦×¨×™× ×‘×¨×›×©</h3>
                        <div id="modalProducts" class="space-y-2 text-sm text-indigo-900">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script type="module">
        import { collection, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        async function loadCustomers() {
            const grid = document.getElementById('customersGrid');
            const snap = await getDocs(collection(window.db, "customers"));
            
            grid.innerHTML = snap.docs.map(doc => {
                const c = doc.data();
                return `
                <div onclick="openCustomerDetails('${doc.id}')" class="bg-white p-6 rounded-3xl shadow-sm border border-transparent hover:border-blue-500 hover:shadow-xl transition-all cursor-pointer group">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center font-black text-xl">
                                ${c.name.charAt(0)}
                            </div>
                            <div>
                                <h3 class="font-bold text-xl text-slate-800">${c.name}</h3>
                                <p class="text-gray-400 text-sm">${c.email || '×œ×§×•×— ×¢×¡×§×™'}</p>
                            </div>
                        </div>
                        <span class="text-blue-500 opacity-0 group-hover:opacity-100 transition-all font-bold italic">×¦×¤×” ×‘×ª×™×§ â”</span>
                    </div>
                </div>
                `;
            }).join('');
        }

        window.openCustomerDetails = async (id) => {
            const modal = document.getElementById('customerModal');
            const snap = await getDocs(collection(window.db, "customers"));
            const cust = snap.docs.find(d => d.id === id).data();

            document.getElementById('modalCustName').innerText = cust.name;
            document.getElementById('modalCustEmail').innerText = cust.email || "";
            document.getElementById('modalNotes').value = cust.notes || "";
            
            // ×—×™×‘×•×¨ ×œ×§×¨×™××•×ª ×©×™×¨×•×ª ××”×¢× ×Ÿ ×œ×¤×™ ×©× ×”×œ×§×•×—
            const tSnap = await getDocs(query(collection(window.db, "tickets"), where("customer", "==", cust.name)));
            document.getElementById('modalTickets').innerHTML = tSnap.docs.map(t => 
                `<div class="p-2 bg-white/50 rounded-lg border border-blue-100">â€¢ ${t.data().issue} (${t.data().status})</div>`
            ).join('') || "××™×Ÿ ×§×¨×™××•×ª ×©×™×¨×•×ª ×¤×ª×•×—×•×ª";

            // ×—×™×‘×•×¨ ×œ××•×¦×¨×™×
            const pSnap = await getDocs(query(collection(window.db, "products"), where("assignedTo", "==", cust.name)));
            document.getElementById('modalProducts').innerHTML = pSnap.docs.map(p => 
                `<div class="p-2 bg-white/50 rounded-lg border border-indigo-100">âœ” ${p.data().name}</div>`
            ).join('') || "×˜×¨× × ×¨×›×©×• ××•×¦×¨×™×";

            window.currentCustId = id;
            modal.classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('customerModal').classList.add('hidden');

        document.getElementById('saveNoteBtn').onclick = async () => {
            const note = document.getElementById('modalNotes').value;
            await window.DreamCRM.updateInfo("customers", window.currentCustId, note);
            alert("×”××™×“×¢ × ×©××¨ ×‘×ª×™×§ ×”×œ×§×•×—!");
            loadCustomers();
        };

        window.onload = loadCustomers;
    </script>
</body>
</html>
